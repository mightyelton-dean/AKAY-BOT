<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AKAY Bot - WhatsApp Automation Platform</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="auth.js"></script>
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <rect width="32" height="32" rx="8" fill="currentColor"/>
                    <path d="M16 8L24 12V20L16 24L8 20V12L16 8Z" fill="white"/>
                </svg>
                <span>AKAY</span>
            </div>
        </div>
        <nav class="nav">
            <a href="#" class="nav-item" data-page="connect">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><rect x="3" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="11" y="3" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="3" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="11" y="11" width="6" height="6" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>
                <span>Connect WhatsApp</span>
            </a>
            <a href="#" class="nav-item active" data-page="overview">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M3 14L7 10L11 14L17 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-page="conversations">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M3 5.5C3 4.11929 4.11929 3 5.5 3H14.5C15.8807 3 17 4.11929 17 5.5V11.5C17 12.8807 15.8807 14 14.5 14H7L3 17V5.5Z" stroke="currentColor" stroke-width="1.5"/></svg>
                <span>Conversations</span>
            </a>
            <a href="#" class="nav-item" data-page="knowledge">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2C10 2 4 5 4 11C4 14.3137 6.68629 17 10 17C13.3137 17 16 14.3137 16 11C16 5 10 2 10 2Z" stroke="currentColor" stroke-width="1.5"/><path d="M10 12V10M10 8H10.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                <span>Knowledge Base</span>
            </a>
            <a href="#" class="nav-item" data-page="sessions">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="7" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M4 17C4 13.686 6.68629 11 10 11C13.3137 11 16 13.686 16 17" stroke="currentColor" stroke-width="1.5"/></svg>
                <span>Sessions</span>
            </a>
            <a href="#" class="nav-item" data-page="broadcast">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M2 10H6L10 3L14 17L18 10H22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Broadcast</span>
            </a>
            <a href="#" class="nav-item" data-page="settings">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M10 2V4M10 16V18M4.93 4.93L6.34 6.34M13.66 13.66L15.07 15.07M2 10H4M16 10H18M4.93 15.07L6.34 13.66M13.66 6.34L15.07 4.93" stroke="currentColor" stroke-width="1.5"/></svg>
                <span>Settings</span>
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="avatar" id="userAvatar">AD</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Admin</div>
                    <div class="user-role">Administrator</div>
                </div>
                <button class="btn-icon-small logout-btn" onclick="logout()" title="Logout">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M6 14H3C2.44772 14 2 13.5523 2 13V3C2 2.44772 2.44772 2 3 2H6M11 11L14 8M14 8L11 5M14 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header">
            <div class="header-left">
                <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleSidebar()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <h1 class="page-title">Dashboard</h1>
                <div class="status-badge disconnected" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span id="statusText">Disconnected</span>
                </div>
            </div>
        </header>

        <!-- CONNECT PAGE -->
        <div class="content" id="connect-page" style="display:none;">
            <div class="connect-card">
                <div class="qr-section">
                    <h2>Connect Your WhatsApp</h2>
                    <p id="connectSubtitle">Choose how to link your WhatsApp account to the bot</p>

                    <!-- Status display -->
                    <div id="connectStatusBanner" class="connect-banner" style="display:none;"></div>

                    <!-- QR Code display -->
                    <div class="qr-code-wrapper" id="qrWrapper" style="display:none;">
                        <img id="qrImage" src="" alt="QR Code" style="width:220px;height:220px;border-radius:8px;">
                        <p class="qr-hint">Scan with WhatsApp ‚Üí Settings ‚Üí Linked Devices ‚Üí Link a Device</p>
                        <p class="qr-hint" style="color:var(--color-text-tertiary);font-size:12px;">QR expires in 60s ‚Äî refreshes automatically</p>
                    </div>

                    <!-- Pairing code display -->
                    <div id="pairingWrapper" style="display:none; text-align:center; padding: 24px 0;">
                        <div class="pairing-code-display" id="pairingCodeDisplay">----</div>
                        <p class="qr-hint">Enter this code in WhatsApp ‚Üí Settings ‚Üí Linked Devices ‚Üí Link with phone number instead</p>
                    </div>

                    <!-- Connected state -->
                    <div id="connectedWrapper" style="display:none; text-align:center; padding:32px 0;">
                        <div style="font-size:48px; margin-bottom:12px;">‚úÖ</div>
                        <h3 style="color:var(--color-success)">Connected!</h3>
                        <p id="connectedPhone" style="color:var(--color-text-secondary); margin-top:8px;"></p>
                    </div>

                    <!-- Idle / choose method -->
                    <div id="connectActions">
                        <div class="connect-method-row">
                            <div class="connect-method-card" onclick="requestQR()">
                                <div class="method-icon">üì∑</div>
                                <h3>Scan QR Code</h3>
                                <p>Scan with your phone camera</p>
                                <button class="btn-primary" style="margin-top:12px;">Generate QR</button>
                            </div>
                            <div class="connect-method-card" id="pairingMethodCard">
                                <div class="method-icon">üî¢</div>
                                <h3>Pairing Code</h3>
                                <p>Enter your WhatsApp number</p>
                                <div style="margin-top:12px; display:flex; gap:8px;">
                                    <input type="tel" id="pairingPhoneInput" class="form-control"
                                        placeholder="+234 901 234 5678"
                                        style="flex:1; font-size:13px;"
                                        onkeydown="if(event.key==='Enter') requestPairingCode()">
                                    <button class="btn-primary" onclick="requestPairingCode()">Get Code</button>
                                </div>
                            </div>
                        </div>

                        <div id="disconnectSection" style="display:none; text-align:center; margin-top:24px;">
                            <button class="btn-danger" onclick="disconnectWhatsApp()">‚ö†Ô∏è Disconnect WhatsApp</button>
                            <p style="font-size:12px; color:var(--color-text-tertiary); margin-top:8px;">This will log out and require re-pairing</p>
                        </div>
                    </div>
                </div>

                <div class="instructions">
                    <h3>üìã How to connect:</h3>
                    <div class="instruction-tabs">
                        <div class="instruction-block">
                            <strong>Option A ‚Äî QR Code</strong>
                            <ol>
                                <li>Click <em>Generate QR</em></li>
                                <li>Open WhatsApp on your phone</li>
                                <li>Go to <strong>Settings ‚Üí Linked Devices</strong></li>
                                <li>Tap <strong>Link a Device</strong></li>
                                <li>Scan the QR code</li>
                            </ol>
                        </div>
                        <div class="instruction-block" style="margin-top:16px;">
                            <strong>Option B ‚Äî Pairing Code</strong>
                            <ol>
                                <li>Enter your WhatsApp phone number</li>
                                <li>Click <em>Get Code</em></li>
                                <li>Open WhatsApp ‚Üí <strong>Settings ‚Üí Linked Devices</strong></li>
                                <li>Tap <strong>Link a Device ‚Üí Link with phone number instead</strong></li>
                                <li>Enter the 8-digit code</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DASHBOARD PAGE -->
        <div class="content" id="overview-page">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-label">Total Messages</span></div>
                    <div class="stat-value" id="statTotalMessages">‚Äî</div>
                    <div class="stat-change positive">All time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-label">Active Users (24h)</span></div>
                    <div class="stat-value" id="statActiveUsers">‚Äî</div>
                    <div class="stat-change positive">Last 24 hours</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-label">Total Users</span></div>
                    <div class="stat-value" id="statTotalUsers">‚Äî</div>
                    <div class="stat-change">Unique contacts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><span class="stat-label">Conversations</span></div>
                    <div class="stat-value" id="statTotalConversations">‚Äî</div>
                    <div class="stat-change">All chats</div>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <h2>Message Activity</h2>
                </div>
                <canvas id="messageChart"></canvas>
            </div>
        </div>

        <!-- CONVERSATIONS PAGE -->
        <div class="content" id="conversations-page" style="display:none;">
            <div class="conversations-layout">
                <div class="conversations-sidebar">
                    <div class="page-header">
                        <h2>Conversations</h2>
                        <div class="search-box">
                            <input type="text" placeholder="Search..." oninput="filterConversations(this.value)">
                        </div>
                    </div>
                    <div id="conversationsList" class="conversations-list">
                        <div class="empty-state">
                            <h3>No conversations yet</h3>
                            <p>Connect WhatsApp to start receiving messages</p>
                        </div>
                    </div>
                </div>
                <div class="message-panel" id="messagePanel" style="display:none;">
                    <div class="message-panel-header">
                        <button class="btn-icon-small" onclick="document.getElementById('messagePanel').style.display='none'">‚Üê</button>
                        <span id="messagePanelTitle"></span>
                    </div>
                    <div class="messages-list" id="messagesList"></div>
                </div>
            </div>
        </div>

        <!-- KNOWLEDGE BASE PAGE -->
        <div class="content" id="knowledge-page" style="display:none;">
            <div class="page-header">
                <h2>Knowledge Base</h2>
            </div>

            <!-- Chat Export Upload -->
            <div class="settings-card import-card">
                <h3>üìÅ Import WhatsApp Chat Export</h3>
                <p class="help-text">Export a chat from WhatsApp (Chat ‚Üí More ‚Üí Export Chat ‚Üí Without Media) and upload the .txt file here. The bot will learn from your past replies.</p>
                <div class="import-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Your Name in the Chat</label>
                            <input type="text" id="yourName" class="form-control" placeholder="e.g. EltonDean ‚Äî exactly as it appears in the .txt file">
                        </div>
                        <div class="form-group">
                            <label>Chat Export File (.txt)</label>
                            <input type="file" id="chatExportFile" class="form-control" accept=".txt,.zip">
                        </div>
                    </div>
                    <button class="btn-primary" onclick="importChatExport()">Import & Train Bot</button>
                </div>
                <div id="importStatus" class="import-status" style="display:none;"></div>
            </div>

            <!-- Manual Add -->
            <div class="settings-card">
                <h3>Add FAQ Manually</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>Question</label>
                        <input type="text" id="kbQuestion" class="form-control" placeholder="e.g. What are your delivery areas?">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="kbCategory" class="form-control">
                            <option value="general">General</option>
                            <option value="pricing">Pricing</option>
                            <option value="delivery">Delivery</option>
                            <option value="orders">Orders</option>
                            <option value="payment">Payment</option>
                            <option value="hours">Hours</option>
                            <option value="products">Products</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Answer</label>
                    <textarea id="kbAnswer" class="form-control" rows="3" placeholder="e.g. We deliver to Lagos Island, Lekki, and Victoria Island."></textarea>
                </div>
                <button class="btn-primary" onclick="addKBEntry()">Add Entry</button>
            </div>

            <!-- FAQ Table -->
            <div class="table-card">
                <div class="table-header">
                    <h3>FAQ Entries</h3>
                    <button class="btn-secondary btn-sm" onclick="loadKnowledgeBase()">Refresh</button>
                </div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr><th>Question</th><th>Answer</th><th>Category</th><th></th></tr>
                        </thead>
                        <tbody id="kbTableBody">
                            <tr><td colspan="4" class="loading-text">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- SESSIONS PAGE -->
        <div class="content" id="sessions-page" style="display:none;">
            <div class="page-header">
                <h2>Active Sessions <span class="badge" id="activeSessionsCount">0</span></h2>
                <button class="btn-secondary" onclick="loadSessions()">Refresh</button>
            </div>
            <p class="help-text" style="margin-bottom:16px;">Sessions track users mid-conversation (e.g. placing an order). They're stored in SQLite and survive bot restarts.</p>
            <div class="table-card">
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr><th>User</th><th>State</th><th>Last Activity</th><th></th></tr>
                        </thead>
                        <tbody id="sessionsTableBody">
                            <tr><td colspan="4" class="loading-text">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- BROADCAST PAGE -->
        <div class="content" id="broadcast-page" style="display:none;">
            <div class="broadcast-container">
                <div class="form-section">
                    <h2>Send Broadcast</h2>
                    <p class="help-text" style="margin-bottom:16px;">‚ö†Ô∏è WhatsApp may restrict accounts that send bulk messages to people who haven't messaged first. Use responsibly.</p>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea class="form-control" rows="8" placeholder="Type your broadcast message..."></textarea>
                    </div>
                    <button class="btn-primary btn-large" onclick="showToast('Broadcast feature coming soon')">Send Broadcast</button>
                </div>
            </div>
        </div>

        <!-- SETTINGS PAGE -->
        <div class="content" id="settings-page" style="display:none;">
            <h2>Settings</h2>
            <div class="settings-card">
                <h3>AI Configuration</h3>
                <p class="help-text">These settings are saved locally. To change the actual AI model, update <code>AI_MODEL</code> in your backend <code>.env</code> file.</p>
                <div class="form-group">
                    <label>AI Model</label>
                    <select class="form-control" id="aiModel">
                        <option value="claude-haiku-4-5">Claude Haiku 4.5 (Fast & Cheap)</option>
                        <option value="claude-sonnet-4-5">Claude Sonnet 4.5 (Recommended)</option>
                        <option value="claude-opus-4-5">Claude Opus 4.5 (Most Capable)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>System Prompt Reference</label>
                    <textarea class="form-control" rows="6" id="systemPrompt" placeholder="View/note your system prompt here. To change it, edit services/aiService.js in the backend.">You are a helpful WhatsApp AI assistant...</textarea>
                </div>
                <button class="btn-primary" onclick="saveSettings()">Save Notes</button>
            </div>
            <div class="settings-card">
                <h3>Backend Connection</h3>
                <p class="help-text">This dashboard proxies API calls to your Baileys bot backend. Make sure both servers are running.</p>
                <div class="form-group">
                    <label>Backend URL (set in dashboard .env)</label>
                    <input type="text" class="form-control" value="http://localhost:3001" disabled>
                </div>
                <button class="btn-secondary" onclick="refreshStatus().then(() => showToast('Status refreshed'))">Test Connection</button>
            </div>
        </div>

    </main>

    <script src="script.js"></script>
</body>
</html>
